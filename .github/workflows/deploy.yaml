name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build image
        run: docker build -t ghcr.io/baokun77/api:latest .

      - name: Push image
        run: |
          echo ${{ secrets.CR_PAT }} | docker login ghcr.io -u baokun77 --password-stdin
          docker push ghcr.io/baokun77/api:latest

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Setup kind
        uses: helm/kind-action@v1.8.0

      - name: Install SOPS
        run: |
          SOPS_VERSION="v3.11.0"
          curl -L "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" -o sops
          sudo mv sops /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops

      - name: Decrypt secrets with SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          # Create age key file from secret
          if [ -n "$SOPS_AGE_KEY" ]; then
            echo "$SOPS_AGE_KEY" > /tmp/age-key.txt
            chmod 600 /tmp/age-key.txt
            export SOPS_AGE_KEY_FILE=/tmp/age-key.txt
            echo "Age key file created from secret"
          else
            echo "Warning: SOPS_AGE_KEY secret not set, skipping decryption"
          fi
          
          # Decrypt secret files and save as .yaml (without .enc)
          # Find all .enc.yaml files and decrypt them
          for enc_file in $(find k8s -name "*.enc.yaml" -type f); do
            dec_file="${enc_file%.enc.yaml}.yaml"
            echo "Decrypting $enc_file to $dec_file"
            sops -d "$enc_file" > "$dec_file" || {
              echo "Error: Failed to decrypt $enc_file"
              exit 1
            }
            echo "âœ“ Successfully decrypted $enc_file"
          done
          
          # Clean up age key file
          rm -f /tmp/age-key.txt
          
          # Verify at least one secret was decrypted (if any exist)
          if [ -n "$(find k8s -name "*.enc.yaml" -type f)" ]; then
            echo "All secrets decrypted successfully"
          else
            echo "No encrypted secrets found (this is OK if you don't have secrets)"
          fi

      - name: Create kind cluster
        run: |
          kind create cluster --name ci --wait 5m

      - name: Load image to kind
        run: |
          kind load docker-image ghcr.io/baokun77/api:latest --name ci

      - name: Apply Kubernetes manifests
        run: |
          # Apply all YAML files (including decrypted secrets)
          find k8s -name "*.yaml" -o -name "*.yml" | grep -v "\.enc\.yaml$" | xargs -I {} kubectl apply -f {}

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/api -n default || true
          kubectl get pods
          kubectl get deployments

      - name: Deploy to K8s
        run: |
          kubectl set image deployment/api api=ghcr.io/baokun77/api:latest
          kubectl rollout status deployment/api --timeout=300s

